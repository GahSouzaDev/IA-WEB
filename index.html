<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector de Defeitos em Placas Eletr√¥nicas</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.0.4/dist/mobilenet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier@1.2.2/dist/knn-classifier.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        .camera-container {
            position: relative;
            width: 100%;
            height: auto;
            aspect-ratio: 4/3;
            margin: 0 auto 15px;
            border: 3px solid #ddd;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .controls {
            margin: 15px 0;
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 12px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            transition: background-color 0.3s;
            min-width: 120px;
        }
        button:hover {
            opacity: 0.9;
        }
        button#add-defective {
            background-color: #f44336;
        }
        button#add-defective:hover {
            background-color: #d32f2f;
        }
        button#train {
            background-color: #2196F3;
        }
        button#train:hover {
            background-color: #0b7dda;
        }
        button#reset {
            background-color: #ff9800;
        }
        button#toggle-camera {
            background-color: #9C27B0;
        }
        button#toggle-flash {
            background-color: #607D8B;
        }
        #status {
            margin: 15px 0;
            padding: 8px;
            background-color: #eee;
            border-radius: 5px;
            min-height: 20px;
            font-size: 14px;
        }
        .thumbnail-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
        }
        .thumbnail {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        .thumbnail.correct {
            border-color: #4CAF50;
        }
        .thumbnail.defective {
            border-color: #f44336;
        }
        .prediction-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        .mobile-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .mobile-controls button {
            padding: 8px;
            min-width: auto;
            flex: 1;
        }
        @media (max-width: 480px) {
            button {
                padding: 8px 10px;
                font-size: 13px;
                min-width: 100px;
            }
            h1 {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
    <h1>Detector de Defeitos em Placas Eletr√¥nicas</h1>
    
    <div class="camera-container">
        <video id="webcam" autoplay playsinline muted></video>
        <div id="prediction" class="prediction-overlay">Aguardando an√°lise...</div>
    </div>
    
    <div class="mobile-controls">
        <button id="toggle-camera">üîÑ C√¢mera</button>
        <button id="toggle-flash">‚ö° LED</button>
    </div>
    
    <div class="controls">
        <button id="add-correct">Adicionar Correta</button>
        <button id="add-defective">Adicionar Defeituosa</button>
        <button id="train">Treinar Modelo</button>
        <button id="reset">Resetar</button>
    </div>
    
    <div id="status">Aguardando acesso √† c√¢mera...</div>
    
    <h3>Imagens de Treino</h3>
    <div class="thumbnail-container" id="thumbnails"></div>

    <script>
        // Elementos da interface
        const webcam = document.getElementById('webcam');
        const predictionElement = document.getElementById('prediction');
        const statusElement = document.getElementById('status');
        const thumbnailsContainer = document.getElementById('thumbnails');
        
        // Vari√°veis do modelo
        let net;
        let classifier;
        let isPredicting = false;
        let currentStream = null;
        let facingMode = "environment"; // Come√ßa com c√¢mera traseira
        let flashOn = false;
        let track = null;
        
        // Inicializar a aplica√ß√£o
        async function init() {
            try {
                // Carregar modelos
                statusElement.textContent = 'Carregando modelos...';
                [net, classifier] = await Promise.all([
                    mobilenet.load(),
                    knnClassifier.create()
                ]);
                
                // Iniciar c√¢mera
                await startCamera();
                
            } catch (error) {
                statusElement.textContent = `Erro: ${error.message}`;
                console.error(error);
            }
        }
        
        // Iniciar c√¢mera com configura√ß√µes
        async function startCamera() {
            statusElement.textContent = 'Iniciando c√¢mera...';
            
            // Parar stream anterior se existir
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            
            const constraints = {
                video: {
                    facingMode: facingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            };
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                webcam.srcObject = stream;
                
                // Obter track de v√≠deo para controlar o flash
                track = stream.getVideoTracks()[0];
                
                await new Promise((resolve) => {
                    webcam.onloadedmetadata = () => {
                        resolve();
                    };
                });
                
                statusElement.textContent = 'Pronto para capturar imagens!';
                return true;
            } catch (error) {
                statusElement.textContent = `Erro na c√¢mera: ${error.message}`;
                console.error(error);
                return false;
            }
        }
        
        // Alternar entre c√¢meras frontal e traseira
        async function toggleCamera() {
            facingMode = facingMode === "user" ? "environment" : "user";
            statusElement.textContent = `Alternando para c√¢mera ${facingMode === "user" ? "frontal" : "traseira"}...`;
            const success = await startCamera();
            if (success) {
                statusElement.textContent = `C√¢mera ${facingMode === "user" ? "frontal" : "traseira"} ativada!`;
            }
        }
        
        // Ligar/desligar flash (se dispon√≠vel)
        async function toggleFlash() {
            if (!track || !track.getCapabilities().torch) {
                statusElement.textContent = 'Flash n√£o dispon√≠vel neste dispositivo';
                return;
            }
            
            try {
                flashOn = !flashOn;
                await track.applyConstraints({
                    advanced: [{ torch: flashOn }]
                });
                statusElement.textContent = `Flash ${flashOn ? 'ligado' : 'desligado'}`;
            } catch (error) {
                statusElement.textContent = 'Erro ao controlar flash';
                console.error(error);
            }
        }
        
        // Adicionar imagem ao classificador
        async function addExample(classId) {
            statusElement.textContent = `Capturando imagem ${classId}...`;
            
            // Capturar imagem da c√¢mera
            const img = tf.browser.fromPixels(webcam);
            const processedImg = tf.image.resizeBilinear(img, [224, 224]);
            
            // Obter ativa√ß√£o do MobileNet
            const activation = net.infer(processedImg, 'conv_preds');
            
            // Adicionar ao classificador
            classifier.addExample(activation, classId);
            
            // Criar miniatura
            createThumbnail(img, classId);
            
            // Limpar mem√≥ria
            img.dispose();
            processedImg.dispose();
            activation.dispose();
            
            statusElement.textContent = `Imagem ${classId} adicionada. Total: ${classifier.getNumExamples()}`;
        }
        
        // Criar miniatura para visualiza√ß√£o
        function createThumbnail(imgTensor, classId) {
            const canvas = document.createElement('canvas');
            canvas.width = 224;
            canvas.height = 224;
            tf.browser.toPixels(imgTensor, canvas).then(() => {
                const thumbnail = document.createElement('img');
                thumbnail.src = canvas.toDataURL();
                thumbnail.classList.add('thumbnail', classId);
                thumbnailsContainer.appendChild(thumbnail);
            });
        }
        
        // Treinar modelo (na verdade, apenas preparar para predi√ß√£o)
        async function train() {
            if (classifier.getNumExamples() === 0) {
                statusElement.textContent = 'Adicione imagens antes de treinar';
                return;
            }
            
            statusElement.textContent = 'Preparando modelo...';
            isPredicting = true;
            statusElement.textContent = 'Modelo pronto! Analisando...';
            
            // Iniciar loop de predi√ß√£o
            while (isPredicting) {
                await predict();
                await tf.nextFrame(); // Liberar o event loop
            }
        }
        
        // Fazer predi√ß√£o
        async function predict() {
            if (!isPredicting) return;
            
            const img = tf.browser.fromPixels(webcam);
            const processedImg = tf.image.resizeBilinear(img, [224, 224]);
            const activation = net.infer(processedImg, 'conv_preds');
            
            const result = await classifier.predictClass(activation);
            
            // Mostrar resultado
            if (result.confidences[result.label] > 0.7) {
                predictionElement.textContent = result.label === 'correta' ? '‚úÖ CORRETA' : '‚ùå DEFEITUOSA';
                predictionElement.style.color = result.label === 'correta' ? '#4CAF50' : '#f44336';
            } else {
                predictionElement.textContent = 'Analisando...';
                predictionElement.style.color = 'white';
            }
            
            // Limpar mem√≥ria
            img.dispose();
            processedImg.dispose();
            activation.dispose();
        }
        
        // Resetar aplica√ß√£o
        function reset() {
            isPredicting = false;
            classifier.clearAllClasses();
            thumbnailsContainer.innerHTML = '';
            predictionElement.textContent = 'Aguardando an√°lise...';
            predictionElement.style.color = 'white';
            statusElement.textContent = 'Aplica√ß√£o resetada. Pronto para novas imagens.';
        }
        
        // Event listeners
        document.getElementById('add-correct').addEventListener('click', () => addExample('correta'));
        document.getElementById('add-defective').addEventListener('click', () => addExample('defeituosa'));
        document.getElementById('train').addEventListener('click', train);
        document.getElementById('reset').addEventListener('click', reset);
        document.getElementById('toggle-camera').addEventListener('click', toggleCamera);
        document.getElementById('toggle-flash').addEventListener('click', toggleFlash);
        
        // Verificar se √© mobile
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // Ajustar interface para mobile
        function adaptForMobile() {
            if (isMobile()) {
                // Mostrar controles espec√≠ficos para mobile
                document.querySelector('.mobile-controls').style.display = 'flex';
            }
        }
        
        // Iniciar aplica√ß√£o
        adaptForMobile();
        init();
    </script>
</body>
</html>