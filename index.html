<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector de Defeitos em Placas Eletrônicas</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.0.4/dist/mobilenet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier@1.2.2/dist/knn-classifier.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .camera-container {
            position: relative;
            width: 640px;
            height: 480px;
            margin: 0 auto 20px;
            border: 3px solid #ddd;
            background-color: #000;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button#add-defective {
            background-color: #f44336;
        }
        button#add-defective:hover {
            background-color: #d32f2f;
        }
        button#train {
            background-color: #2196F3;
        }
        button#train:hover {
            background-color: #0b7dda;
        }
        button#reset {
            background-color: #ff9800;
        }
        button#reset:hover {
            background-color: #e68a00;
        }
        #status {
            margin: 20px 0;
            padding: 10px;
            background-color: #eee;
            border-radius: 5px;
            min-height: 20px;
        }
        .thumbnail-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .thumbnail {
            width: 100px;
            height: 75px;
            object-fit: cover;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        .thumbnail.correct {
            border-color: #4CAF50;
        }
        .thumbnail.defective {
            border-color: #f44336;
        }
        .prediction-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 4px;
            font-weight: bold;
        }
        @media (max-width: 700px) {
            .camera-container {
                width: 100%;
                height: auto;
                aspect-ratio: 4/3;
            }
        }
    </style>
</head>
<body>
    <h1>Detector de Defeitos em Placas Eletrônicas</h1>
    
    <div class="camera-container">
        <video id="webcam" autoplay playsinline muted></video>
        <div id="prediction" class="prediction-overlay">Aguardando análise...</div>
    </div>
    
    <div class="controls">
        <button id="add-correct">Adicionar Correta</button>
        <button id="add-defective">Adicionar Defeituosa</button>
        <button id="train">Treinar Modelo</button>
        <button id="reset">Resetar</button>
    </div>
    
    <div id="status">Aguardando acesso à câmera...</div>
    
    <h3>Imagens de Treino</h3>
    <div class="thumbnail-container" id="thumbnails"></div>

    <script>
        // Elementos da interface
        const webcam = document.getElementById('webcam');
        const predictionElement = document.getElementById('prediction');
        const statusElement = document.getElementById('status');
        const thumbnailsContainer = document.getElementById('thumbnails');
        
        // Variáveis do modelo
        let net;
        let classifier;
        let isPredicting = false;
        
        // Inicializar a aplicação
        async function init() {
            try {
                // Carregar modelos
                statusElement.textContent = 'Carregando modelos...';
                [net, classifier] = await Promise.all([
                    mobilenet.load(),
                    knnClassifier.create()
                ]);
                
                // Iniciar câmera
                statusElement.textContent = 'Iniciando câmera...';
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcam.srcObject = stream;
                
                statusElement.textContent = 'Pronto para capturar imagens!';
            } catch (error) {
                statusElement.textContent = `Erro: ${error.message}`;
                console.error(error);
            }
        }
        
        // Adicionar imagem ao classificador
        async function addExample(classId) {
            statusElement.textContent = `Capturando imagem ${classId}...`;
            
            // Capturar imagem da câmera
            const img = tf.browser.fromPixels(webcam);
            const processedImg = tf.image.resizeBilinear(img, [224, 224]);
            
            // Obter ativação do MobileNet
            const activation = net.infer(processedImg, 'conv_preds');
            
            // Adicionar ao classificador
            classifier.addExample(activation, classId);
            
            // Criar miniatura
            createThumbnail(img, classId);
            
            // Limpar memória
            img.dispose();
            processedImg.dispose();
            activation.dispose();
            
            statusElement.textContent = `Imagem ${classId} adicionada. Total: ${classifier.getNumExamples()}`;
        }
        
        // Criar miniatura para visualização
        function createThumbnail(imgTensor, classId) {
            const canvas = document.createElement('canvas');
            canvas.width = 224;
            canvas.height = 224;
            tf.browser.toPixels(imgTensor, canvas).then(() => {
                const thumbnail = document.createElement('img');
                thumbnail.src = canvas.toDataURL();
                thumbnail.classList.add('thumbnail', classId);
                thumbnailsContainer.appendChild(thumbnail);
            });
        }
        
        // Treinar modelo (na verdade, apenas preparar para predição)
        async function train() {
            if (classifier.getNumExamples() === 0) {
                statusElement.textContent = 'Adicione imagens antes de treinar';
                return;
            }
            
            statusElement.textContent = 'Preparando modelo...';
            isPredicting = true;
            statusElement.textContent = 'Modelo pronto! Analisando...';
            
            // Iniciar loop de predição
            while (isPredicting) {
                await predict();
                await tf.nextFrame(); // Liberar o event loop
            }
        }
        
        // Fazer predição
        async function predict() {
            if (!isPredicting) return;
            
            const img = tf.browser.fromPixels(webcam);
            const processedImg = tf.image.resizeBilinear(img, [224, 224]);
            const activation = net.infer(processedImg, 'conv_preds');
            
            const result = await classifier.predictClass(activation);
            
            // Mostrar resultado
            if (result.confidences[result.label] > 0.7) {
                predictionElement.textContent = result.label === 'correta' ? '✅ CORRETA' : '❌ DEFEITUOSA';
                predictionElement.style.color = result.label === 'correta' ? '#4CAF50' : '#f44336';
            } else {
                predictionElement.textContent = 'Analisando...';
                predictionElement.style.color = 'white';
            }
            
            // Limpar memória
            img.dispose();
            processedImg.dispose();
            activation.dispose();
        }
        
        // Resetar aplicação
        function reset() {
            isPredicting = false;
            classifier.clearAllClasses();
            thumbnailsContainer.innerHTML = '';
            predictionElement.textContent = 'Aguardando análise...';
            predictionElement.style.color = 'white';
            statusElement.textContent = 'Aplicação resetada. Pronto para novas imagens.';
        }
        
        // Event listeners
        document.getElementById('add-correct').addEventListener('click', () => addExample('correta'));
        document.getElementById('add-defective').addEventListener('click', () => addExample('defeituosa'));
        document.getElementById('train').addEventListener('click', train);
        document.getElementById('reset').addEventListener('click', reset);
        
        // Iniciar aplicação
        init();
    </script>
</body>
</html>